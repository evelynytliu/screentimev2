<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Points & Screen Time</title>
  
  <!-- å¼•å…¥ SweetAlert2 (ç¾åŒ–å½ˆçª—) -->
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  
  <!-- å¼•å…¥ Canvas Confetti (å½©å¸¶ç‰¹æ•ˆ) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --primary: #00d4ff;
      --primary-hover: #00b8dd;
      --bg-dark: #111;
      --bg-card: #1c1c3c;
      --bg-input: #222;
      --text-main: #eee;
      --text-muted: #bbb;
      --radius-lg: 20px;
      --radius-sm: 8px;
      --shadow-glow: 0 4px 15px rgba(0,212,255,0.3);
    }

    body {
      font-family: 'Poppins', system-ui, -apple-system, 'Noto Sans TC', sans-serif;
      background: var(--bg-dark);
      color: var(--text-main);
      text-align: center;
      padding: 20px 10px;
      margin: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    h1 { margin: 10px 0 20px; letter-spacing: 1px; }

    /* --- å¡ç‰‡æ¨£å¼ --- */
    .child-card {
      background: var(--bg-card);
      padding: 24px;
      margin: 18px auto;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-glow);
      max-width: 440px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .child-name { font-size: 26px; font-weight: 700; color: var(--primary); margin-bottom: 12px; }

    .points-box {
      background: rgba(0,0,0,0.3);
      padding: 16px;
      border-radius: 16px;
      font-size: 36px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 12px;
      border: 1px solid rgba(0,212,255,0.1);
      text-shadow: 0 0 10px rgba(0,212,255,0.4);
    }
    
    .conversion-info { font-size: 13px; color: var(--text-muted); margin-top: 6px; font-weight: normal; }

    /* --- é€²åº¦æ¢å€å¡Š --- */
    .progress-dual { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 10px; }
    .progress-title { font-size: 14px; color: var(--primary); margin: 6px 0 4px; display: flex; justify-content: space-between; padding: 0 8px; }
    
    .bar-wrap {
      background: #222;
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 30px;
      overflow: hidden;
      height: 36px;
      width: 100%;
      position: relative;
    }
    
    .fill {
      height: 100%;
      width: 0%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(90deg, var(--primary), #005eff);
      box-shadow: 0 0 10px var(--primary);
    }
    
    /* è­¦ç¤ºè‰²ï¼šå‰©é¤˜æ™‚é–“å°‘æ–¼ 50% è®Šæ©˜ï¼Œå°‘æ–¼ 20% è®Šç´… */
    .fill.warning { background: linear-gradient(90deg, #ffaa00, #ff7700); box-shadow: 0 0 10px #ffaa00; }
    .fill.danger { background: linear-gradient(90deg, #ff4444, #ff0000); box-shadow: 0 0 10px #ff0000; }

    .bar-text {
      position: absolute; width: 100%; text-align: center; top: 0; line-height: 36px;
      font-weight: 700; color: #fff; font-size: 15px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      z-index: 2;
      pointer-events: none; /* ç¢ºä¿æ–‡å­—ä¸æœƒå½±éŸ¿é»æ“Š */
    }

    /* --- æŒ‰éˆ•èˆ‡æ§åˆ¶å€ --- */
    .control-row { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 16px 0; }
    .control-row .right { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; } /* æ”¹æˆ3åˆ—æ¯”è¼ƒå¥½æŒ‰ */
    
    .deduct-btn {
      padding: 10px 0; font-size: 15px; border-radius: 12px; border: none;
      background: #333; color: #ccc; cursor: pointer; transition: 0.2s;
    }
    .deduct-btn:active { background: #555; transform: scale(0.95); }

    .chip-toggle {
      background: #222; border-radius: 999px; padding: 4px; display: inline-flex; gap: 4px;
    }
    .chip-toggle button {
      border: none; padding: 8px 16px; border-radius: 999px; background: transparent;
      color: #888; cursor: pointer; font-weight: 600; transition: 0.3s;
    }
    .chip-toggle button.active { background: var(--primary); color: #111; box-shadow: 0 2px 8px rgba(0,212,255,0.4); }

    .convert-group { display: flex; justify-content: center; gap: 12px; margin-top: 8px; }
    .btn {
      padding: 10px 16px; font-size: 15px; border: none; border-radius: 12px;
      color: #eee; font-weight: 700; cursor: pointer; background: #444; transition: 0.2s;
    }
    .btn:hover { background: #555; }
    .btn.primary { background: var(--primary); color: #111; }
    .btn:active { transform: scale(0.96); }

    /* --- è¡¨å–®å€ --- */
    #form-section {
      background: #2a2a5a; padding: 24px 20px; border-radius: 24px;
      max-width: 440px; margin: 24px auto 60px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    input[type="number"], input[type="text"], button.submit-btn {
      padding: 12px; margin: 8px 0; font-size: 16px; border-radius: 10px;
      border: none; width: 100%; box-sizing: border-box;
    }
    input { background: rgba(0,0,0,0.3); color: #fff; border: 1px solid #444; text-align: center; }
    input:focus { outline: none; border-color: var(--primary); }
    
    .submit-btn {
      background: var(--primary); color: #111; font-weight: 800; margin-top: 12px;
      box-shadow: 0 4px 12px rgba(0,212,255,0.4); cursor: pointer;
    }
    .submit-btn:active { transform: scale(0.98); }

    /* --- Filter & Toggle --- */
    #family-filter { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; }
    #family-filter button {
      padding: 8px 16px; font-size: 15px; border-radius: 99px; background: #333;
      color: #ccc; font-weight: 600; border: 1px solid transparent; cursor: pointer;
    }
    #family-filter button.active-filter {
      background: rgba(0,212,255,0.15); color: var(--primary); border-color: var(--primary);
    }

    /* æ–¹æ¡ˆåˆ‡æ› */
    .plan-toggle { background: #222; border-radius: 999px; padding: 4px; display: inline-flex; gap: 4px; margin-top: 10px; }
    .btn-plan {
      border: none; padding: 8px 20px; border-radius: 999px; background: transparent;
      color: #888; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .btn-plan.active { background: var(--primary); color: #111; }

    /* --- Checkbox Group --- */
    .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .checkbox-group input { display: none; }
    .checkbox-group label {
      display: block; padding: 14px; background: #333; color: #ccc; border-radius: 12px;
      font-size: 18px; cursor: pointer; user-select: none; transition: 0.2s; border: 2px solid transparent;
    }
    .checkbox-group input:checked + label {
      background: rgba(0,212,255,0.1); color: var(--primary); border-color: var(--primary); font-weight: bold;
    }

    /* --- Loading & Animations --- */
    .loading-spinner {
      border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .shimmer-effect {
      position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(0,212,255,0.1) 50%, transparent 100%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite; pointer-events: none; z-index: 10;
    }
    @keyframes shimmer { 0%{background-position: 200% 0} 100%{background-position: -200% 0} }

    .pair { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .note { font-size: 12px; color: #888; margin-top: 12px; line-height: 1.6; }
    .pill { display: inline-block; background: #333; padding: 2px 8px; border-radius: 4px; color: #ccc; margin: 0 2px; }
    .preview { margin-top: 8px; font-size: 13px; color: #9ecfff; }
    
    /* SweetAlert è‡ªå®šç¾©æ¨£å¼ */
    .swal2-popup { border-radius: 20px !important; background: #222 !important; border: 1px solid #444; }
    .swal2-title { color: #fff !important; }
    .swal2-content { color: #ccc !important; }
  </style>
</head>
<body>

<h1>â­ Points & Screen Time ğŸ“º</h1>

<div id="family-filter">
  <button type="button" onclick="setFamilyFilter('ev-family')">âš¡ é–ƒé›»æ£®æ—</button>
  <button type="button" onclick="setFamilyFilter('ap-family')">ğŸŠ æŸšæŸšä¾†é»å</button>
  <button type="button" onclick="clearFamilyFilter()" class="small-button">ğŸ”„</button>
</div>

<!-- æ’è¡Œæ¦œå®¹å™¨ -->
<div id="leaderboard">
  <div style="margin:20px">
    <div class="loading-spinner"></div>
    <div style="margin-top:10px;font-size:16px;color:#888">é€£ç·šä¸­...</div>
  </div>
</div>

<!-- æ§åˆ¶è¡¨å–® -->
<div id="form-section">
  <h2 style="margin-top:0;color:#fff;">é€å‡ºæ–°ç´€éŒ„ ğŸ“</h2>
  
  <div id="name-list" class="checkbox-group"></div>

  <div class="plan-toggle" aria-label="é¸æ“‡åˆ†é…æ–¹æ¡ˆ">
    <button type="button" id="alloc-weekday" class="btn-plan" onclick="setAllocPlan('weekday')">å¹³æ—¥</button>
    <button type="button" id="alloc-holiday" class="btn-plan" onclick="setAllocPlan('holiday')">å‡æ—¥</button>
  </div>
  <div id="alloc-preview" class="preview">â€”</div>

  <input type="number" id="pointsChange" placeholder="â­ é»æ•¸èª¿æ•´ï¼ˆè¼¸å…¥æ­£æ•¸æœ‰ç‰¹æ•ˆï¼‰">

  <div class="pair">
    <input type="number" id="selectedMinutesChange" placeholder="ğŸŒŸ ç²¾é¸å¢æ¸›">
    <input type="number" id="regularMinutesChange"  placeholder="ğŸ® ä¸€èˆ¬å¢æ¸›">
  </div>

  <input type="text" id="reason" placeholder="è®Šæ›´åŸå›  (é¸å¡«)">
  
  <button type="button" class="submit-btn" onclick="submitData()">é€å‡º ğŸš€</button>

  <div class="note">
    è¦å‰‡ï¼š<span class="pill">ğŸ®2åˆ† â‡„ â­1é»</span> <span class="pill">â­1é» â†’ ğŸŒŸ3åˆ†</span><br>
    (ğŸŒŸç²¾é¸æ™‚é–“ä¸å¯æ›å›é»æ•¸)
  </div>
</div>

<div style="margin-top:40px;font-size:12px;color:#555;">
  Made by Evelyn YT | Updated 2025
</div>

<script>
  const REFRESH_DELAY = 1000;
  const API_URL = "https://script.google.com/macros/s/AKfycbzk2xXQLv3_e0oktEMZdQjXwkVG9JU6HTolS3dhRH09FPEiHn6dvyAUlUlQZpBAT0rG/exec";
  const PLAN_LIMITS = { weekday:{sel:20, reg:20}, holiday:{sel:30, reg:60} };

  // ç‹€æ…‹è®Šæ•¸
  let currentData = []; // å„²å­˜æœ€æ–°çš„æ•¸æ“š
  let currentSelectedTimes = {};
  let currentRegularTimes  = {};
  let activeType = {}; 
  let updatingChildren = {};
  
  let familyFilter = localStorage.getItem('familyFilter') || '';
  let allocPlan = localStorage.getItem('allocPlan') || 'weekday';
  let selMax = parseInt(localStorage.getItem('selMax')||'0',10);
  let regMax = parseInt(localStorage.getItem('regMax')||'0',10);

  // åˆå§‹åŒ–
  if(!selMax || !regMax){
    selMax = PLAN_LIMITS[allocPlan].sel;
    regMax = PLAN_LIMITS[allocPlan].reg;
  }

  // æ¨¡æ“¬è³‡æ–™ (ç•¶ API é€£ä¸ä¸Šæ™‚ä½¿ç”¨ï¼Œè®“é è¦½åŠŸèƒ½æ­£å¸¸é‹ä½œ)
  const MOCK_DATA = [
    { Name: 'Miles',  Family: 'ev-family', TotalPoints: 15, TotalSelectedMinutes: 10, TotalRegularMinutes: 45 },
    { Name: 'Emmett', Family: 'ev-family', TotalPoints: 8,  TotalSelectedMinutes: 0,  TotalRegularMinutes: 12 },
    { Name: 'Tessa',  Family: 'ap-family', TotalPoints: 22, TotalSelectedMinutes: 25, TotalRegularMinutes: 10 },
    { Name: 'Archer', Family: 'ap-family', TotalPoints: 5,  TotalSelectedMinutes: 5,  TotalRegularMinutes: 55 }
  ];
  let isUsingMock = false;

  document.addEventListener('DOMContentLoaded', ()=>{
    fetchLeaderboard();
    syncAllocPlanButtons();
    updateAllocPreview();
  });

  /* --- æ ¸å¿ƒåŠŸèƒ½ --- */

  function setFamilyFilter(f){ familyFilter=f; localStorage.setItem('familyFilter',f); updateFilterButtons(); renderLeaderboard(currentData); }
  function clearFamilyFilter(){ familyFilter=''; localStorage.removeItem('familyFilter'); updateFilterButtons(); renderLeaderboard(currentData); }
  
  function updateFilterButtons(){
    document.querySelectorAll('#family-filter button').forEach(b=>b.classList.remove('active-filter'));
    if(familyFilter){
      const btn = document.querySelector(`#family-filter button[onclick="setFamilyFilter('${familyFilter}')"]`);
      if(btn) btn.classList.add('active-filter');
    }
  }

  function setAllocPlan(plan){
    allocPlan = plan;
    localStorage.setItem('allocPlan', plan);
    syncAllocPlanButtons();
    const lim = PLAN_LIMITS[plan];
    
    // UI å‹•ç•«
    document.getElementById('selectedMinutesChange').value = lim.sel;
    document.getElementById('regularMinutesChange').value  = lim.reg;
    document.getElementById('reason').value = buildTodayReason();

    selMax = lim.sel; regMax = lim.reg;
    localStorage.setItem('selMax', selMax);
    localStorage.setItem('regMax', regMax);
    
    updateAllocPreview(true);
    // é€™è£¡ä¸éœ€é‡ç¹ªæ•´å€‹åˆ—è¡¨ï¼Œåªéœ€æ›´æ–°é€²åº¦æ¢ä¸Šé™é¡¯ç¤ºå³å¯ï¼Œç°¡å–®èµ·è¦‹é‡ç¹ª
    renderLeaderboard(currentData);
    
    Swal.fire({
        toast: true, position: 'top-end', icon: 'info', 
        title: `å·²åˆ‡æ›ç‚º${plan==='weekday'?'å¹³æ—¥':'å‡æ—¥'}æ–¹æ¡ˆ`,
        showConfirmButton: false, timer: 1500,
        background: '#333', color: '#fff'
    });
  }

  function syncAllocPlanButtons(){
    document.querySelectorAll('.btn-plan').forEach(b=>b.classList.remove('active'));
    document.getElementById(allocPlan==='weekday'?'alloc-weekday':'alloc-holiday').classList.add('active');
  }

  function buildTodayReason(){
    const d = new Date();
    const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
    return `${d.getMonth()+1}/${d.getDate()} (${wd}) åˆ†é…`;
  }

  function updateAllocPreview(bump){
    const el = document.getElementById('alloc-preview');
    const lim = PLAN_LIMITS[allocPlan];
    el.textContent = `ç•¶å‰ï¼š${allocPlan==='weekday'?'å¹³æ—¥':'å‡æ—¥'} (ğŸŒŸ${lim.sel} / ğŸ®${lim.reg}) `;
    if(bump){ el.style.transform='scale(1.1)'; el.style.transition='0.2s'; setTimeout(()=>el.style.transform='scale(1)',200); }
  }

  /* --- è³‡æ–™ç²å– --- */
  
  function fetchLeaderboard(){
    // è¨­å®šä¸€å€‹è¶…æ™‚ï¼Œå¦‚æœ Google Script å¤ªæ…¢æˆ– blockedï¼Œå°±è¼‰å…¥ Mock Data
    const timeoutId = setTimeout(() => {
        if(currentData.length === 0) {
            console.log("API timeout or blocked, using mock data.");
            isUsingMock = true;
            renderLeaderboard(MOCK_DATA);
        }
    }, 2500);

    const callbackName = 'cb_' + Math.floor(Math.random()*1e6);
    window[callbackName] = function(data){
      clearTimeout(timeoutId);
      isUsingMock = false;
      renderLeaderboard(data);
      delete window[callbackName];
    };

    const s = document.createElement('script');
    s.src = `${API_URL}?action=getLeaderboard&callback=${callbackName}`;
    s.onerror = () => {
        // å¦‚æœè¼‰å…¥å¤±æ•— (ä¾‹å¦‚åœ¨ CodePen/é è¦½ç’°å¢ƒ blocked)
        clearTimeout(timeoutId);
        isUsingMock = true;
        renderLeaderboard(MOCK_DATA); 
    };
    document.body.appendChild(s);
    updateFilterButtons();
  }

  function renderLeaderboard(data){
    currentData = data || []; // ä¿å­˜ç•¶å‰æ•¸æ“š
    const leaderboard = document.getElementById('leaderboard');
    
    // éæ¿¾é‚è¼¯
    let displayData = currentData;
    if(familyFilter){
      displayData = currentData.filter(e => {
        if(familyFilter==='ev-family') return ['Miles','Emmett'].includes(e.Name);
        if(familyFilter==='ap-family') return ['Tessa','Archer'].includes(e.Name);
        return true;
      });
    }

    updateNameCheckboxes(displayData);

    let html = '';
    displayData.forEach(entry=>{
      const sel = entry.TotalSelectedMinutes || 0;
      const reg = entry.TotalRegularMinutes  || 0;
      const pts = entry.TotalPoints || 0;

      currentSelectedTimes[entry.Name] = sel;
      currentRegularTimes[entry.Name]  = reg;
      if(!activeType[entry.Name]) activeType[entry.Name] = 'regular'; // é è¨­æ“ä½œä¸€èˆ¬æ™‚é–“

      // è¨ˆç®—ç™¾åˆ†æ¯”
      const selPct = Math.min(100, selMax ? (sel / selMax) * 100 : 0);
      const regPct = Math.min(100, regMax ? (reg / regMax) * 100 : 0);
      
      // é¡è‰²ç‹€æ…‹ (ä¿®æ­£ï¼šå‰©é¤˜æ™‚é–“é‚è¼¯ - æ™‚é–“è¶Šå°‘è¶Šç´…)
      // <= 20% ç´…è‰² (danger), <= 50% æ©˜è‰² (warning)
      const selClass = selPct <= 20 ? 'danger' : (selPct <= 50 ? 'warning' : '');
      const regClass = regPct <= 20 ? 'danger' : (regPct <= 50 ? 'warning' : '');

      const opSel = activeType[entry.Name]==='selected';
      
      // æ§åˆ¶æŒ‰éˆ•å€å¡Š (åˆ†æˆå…©æ’å„ªåŒ–æ‰‹æ©Ÿé¡¯ç¤º)
      const deductButtons = [5,10,20,30,60].map(m => 
        `<button type="button" class="deduct-btn" onclick="deductScreenTime('${entry.Name}', ${m})">-${m}</button>`
      ).join('');

      html += `
      <div class="child-card" id="card-${entry.Name}">
        <div class="child-name">
          ${entry.Name}
          ${updatingChildren[entry.Name] ? '<span style="font-size:14px;opacity:0.7"> æ›´æ–°ä¸­...</span>' : ''}
        </div>

        <div class="points-box">
          â­ ${pts}
          <div class="conversion-info">
            å¯æ›ï¼šğŸŒŸ ${pts * 3} åˆ†ï½œğŸ® ${pts * 2} åˆ†ï½œğŸ’° $${pts * 5}
          </div>
        </div>

        <div class="progress-dual">
          <!-- ç²¾é¸æ™‚é–“ -->
          <div>
            <div class="progress-title">
              <span>ğŸŒŸ ç²¾é¸æ™‚é–“</span>
              <span style="font-size:12px;color:#666">ä¸Šé™: ${selMax}</span>
            </div>
            <div class="bar-wrap">
              <div class="fill ${selClass}" style="width:${selPct}%"></div>
              <div class="bar-text">${sel} åˆ†é˜</div>
            </div>
          </div>
          
          <!-- ä¸€èˆ¬æ™‚é–“ -->
          <div>
            <div class="progress-title">
              <span>ğŸ® ä¸€èˆ¬æ™‚é–“</span>
              <span style="font-size:12px;color:#666">ä¸Šé™: ${regMax}</span>
            </div>
            <div class="bar-wrap">
              <div class="fill ${regClass}" style="width:${regPct}%"></div>
              <div class="bar-text">${reg} åˆ†é˜</div>
            </div>
          </div>
        </div>

        <!-- æ“ä½œå€ -->
        <div class="control-row">
          <div style="display:flex;align-items:center;justify-content:center;margin-bottom:8px;">
             <div class="chip-toggle">
               <button type="button" class="${opSel?'active':''}" onclick="setOpType('${entry.Name}','selected')">ğŸŒŸ ç²¾é¸</button>
               <button type="button" class="${!opSel?'active':''}" onclick="setOpType('${entry.Name}','regular')">ğŸ® ä¸€èˆ¬</button>
             </div>
          </div>
          <div class="right">
            ${deductButtons}
            <button type="button" class="deduct-btn" style="color:#ff6666" onclick="deductScreenTime('${entry.Name}', 'custom')">è‡ªè¨‚</button>
          </div>
        </div>

        <div class="convert-group">
          <button type="button" class="btn" onclick="convertRegularToPoints('${entry.Name}')">ğŸ® â” â­</button>
          <button type="button" class="btn primary convert-pts" onclick="convertPointsToTime('${entry.Name}')">â­ â” ${opSel?'ğŸŒŸ':'ğŸ®'}</button>
        </div>
        
        ${updatingChildren[entry.Name] ? '<div class="shimmer-effect"></div>' : ''}
      </div>
      `;
    });
    
    leaderboard.innerHTML = html;
    if(isUsingMock && document.querySelector('.mock-alert') === null){
         // æç¤ºä½¿ç”¨è€…ç›®å‰æ˜¯é è¦½æ¨¡å¼
         const div = document.createElement('div');
         div.className = 'mock-alert';
         div.style.cssText = "background:#332;color:#fc0;padding:10px;font-size:12px;border-radius:8px;margin:10px;";
         div.innerText = "âš ï¸ é è¦½æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™ (ç„¡æ³•é€£æ¥å¾Œç«¯)";
         leaderboard.prepend(div);
    }
  }

  function updateNameCheckboxes(data){
    const box = document.getElementById('name-list');
    // ä¿æŒå‹¾é¸ç‹€æ…‹çš„é‚è¼¯æœ‰é»è¤‡é›œï¼Œé€™è£¡ç°¡å–®é‡ç¹ª
    const oldChecks = new Set([...document.querySelectorAll('#name-list input:checked')].map(c=>c.value));
    
    box.innerHTML = '';
    data.forEach(e=>{
      const id = 'child-' + e.Name;
      const input = document.createElement('input');
      input.type='checkbox'; input.id=id; input.value=e.Name;
      if(oldChecks.has(e.Name)) input.checked = true;
      
      const label = document.createElement('label');
      label.htmlFor=id; label.textContent=e.Name;
      box.appendChild(input); box.appendChild(label);
    });
  }

  function setOpType(name, type){
    activeType[name] = type;
    // å±€éƒ¨æ›´æ–° DOM ä»¥é¿å…é–ƒçˆ
    renderLeaderboard(currentData);
  }

  /* --- è³‡æ–™æäº¤é‚è¼¯ --- */

  function startShimmer(name){
    updatingChildren[name] = true;
    renderLeaderboard(currentData);
  }
  function stopShimmer(name){
    delete updatingChildren[name];
    // å®Œæˆå¾Œä¸æ€¥è‘—é‡ç¹ªï¼Œç­‰å¾…æ•¸æ“šæ›´æ–°
  }

  // æ¨¡æ“¬ API æäº¤ (ç‚ºäº†é è¦½æ•ˆæœ)
  function mockSubmit(payload, callback){
    console.log("Mock Submit:", payload);
    setTimeout(()=>{
      // æ›´æ–°æœ¬åœ° mock data ä»¥é¡¯ç¤ºè®ŠåŒ–
      const target = MOCK_DATA.find(d=>d.Name === payload.Name);
      if(target){
          target.TotalPoints += (payload.PointsChange||0);
          target.TotalSelectedMinutes += (payload.SelectedMinutesChange||0);
          target.TotalRegularMinutes += (payload.RegularMinutesChange||0);
      }
      callback();
    }, 600);
  }

  function submitToApi(payload, callback){
    if(isUsingMock) {
        mockSubmit(payload, callback);
        return;
    }
    // é€™è£¡ä½¿ç”¨ JSONP æˆ– iframe æ–¹å¼ (ä¿æŒä½ åŸæœ¬çš„é‚è¼¯)
    const iframe = document.createElement('iframe');
    iframe.style.display='none';
    iframe.onload = function(){ callback(); this.remove(); };
    // æ³¨æ„ï¼šJSON.stringify å¯èƒ½éœ€è¦ encodeURIComponent
    iframe.src = `${API_URL}?action=submit&data=${encodeURIComponent(JSON.stringify(payload))}`;
    document.body.appendChild(iframe);
  }

  function submitData(){
    const checked = [...document.querySelectorAll('#name-list input[type="checkbox"]:checked')];
    const ptsVal = document.getElementById('pointsChange').value.trim();
    const selVal = document.getElementById('selectedMinutesChange').value.trim();
    const regVal = document.getElementById('regularMinutesChange').value.trim();
    const reason = document.getElementById('reason').value.trim();

    if(checked.length===0){ Swal.fire({icon:'warning', title:'è«‹é¸æ“‡å°å­©'}); return; }
    if(!ptsVal && !selVal && !regVal){ Swal.fire({icon:'warning', title:'è«‹è¼¸å…¥æ•¸å€¼'}); return; }

    // æ…¶ç¥ç‰¹æ•ˆï¼
    if(parseInt(ptsVal) > 0) {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#00d4ff', '#ff0', '#f0f']
        });
    }

    const btn = document.querySelector('.submit-btn');
    btn.disabled = true; btn.style.opacity = 0.5;

    let doneCount = 0;
    checked.forEach(cb => {
      const name = cb.value;
      const family = (name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
      
      startShimmer(name);
      
      const payload = {
        Family: family, Name: name,
        PointsChange: ptsVal ? parseInt(ptsVal,10) : 0,
        SelectedMinutesChange: selVal ? parseInt(selVal,10) : 0,
        RegularMinutesChange: regVal ? parseInt(regVal,10) : 0,
        Reason: reason || 'æ‰‹å‹•èª¿æ•´'
      };

      submitToApi(payload, () => {
        doneCount++;
        stopShimmer(name);
        if(doneCount === checked.length){
          btn.disabled = false; btn.style.opacity = 1;
          
          // æ¸…ç©ºè¼¸å…¥
          document.getElementById('pointsChange').value='';
          document.getElementById('selectedMinutesChange').value='';
          document.getElementById('regularMinutesChange').value='';
          document.querySelectorAll('#name-list input').forEach(c=>c.checked=false);

          // æˆåŠŸæç¤º
          Swal.fire({
             icon: 'success',
             title: 'æ›´æ–°æˆåŠŸ!',
             text: 'è³‡æ–™å·²åŒæ­¥',
             timer: 1500,
             showConfirmButton: false,
             background: '#333', color: '#fff'
          });
          
          // é‡æ–°æŠ“å–æ•¸æ“š
          if(isUsingMock) renderLeaderboard(MOCK_DATA);
          else setTimeout(fetchLeaderboard, REFRESH_DELAY);
        }
      });
    });
  }

  function deductScreenTime(name, minutes){
    const type = activeType[name] || 'regular';
    
    // è™•ç†è‡ªè¨‚è¼¸å…¥
    if(minutes === 'custom'){
        Swal.fire({
            title: `æ‰£é™¤${type==='selected'?'ğŸŒŸç²¾é¸':'ğŸ®ä¸€èˆ¬'}æ™‚é–“`,
            input: 'number',
            inputLabel: 'è¼¸å…¥åˆ†é˜æ•¸',
            background: '#333', color:'#fff', confirmButtonColor: '#d33',
            showCancelButton: true
        }).then((result) => {
            if(result.isConfirmed && result.value) {
                deductScreenTime(name, parseInt(result.value));
            }
        });
        return;
    }

    const current = (type==='selected') ? (currentSelectedTimes[name]||0) : (currentRegularTimes[name]||0);
    if(current < minutes){ 
        Swal.fire({icon:'error', title:'æ™‚é–“ä¸è¶³', text:`ç›®å‰åªæœ‰ ${current} åˆ†é˜`, background:'#333', color:'#fff'}); 
        return; 
    }

    Swal.fire({
        title: `ç¢ºèªæ‰£é™¤ ${minutes} åˆ†?`,
        text: `é¡åˆ¥: ${type==='selected'?'ğŸŒŸç²¾é¸':'ğŸ®ä¸€èˆ¬'}`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'æ‰£é™¤',
        cancelButtonText: 'å–æ¶ˆ',
        background: '#333', color: '#fff'
    }).then((result) => {
        if (result.isConfirmed) {
            startShimmer(name);
            const family=(name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
            const payload={
              Family:family, Name:name, PointsChange:0,
              SelectedMinutesChange: type==='selected' ? -minutes : 0,
              RegularMinutesChange:  type==='regular' ? -minutes : 0,
              Reason:`æ‰£é™¤${type==='selected'?'ç²¾é¸':'ä¸€èˆ¬'} ${minutes}åˆ†`
            };
            submitToApi(payload, ()=> {
                stopShimmer(name);
                Swal.fire({icon:'success', title:'å·²æ‰£é™¤', timer:1000, showConfirmButton:false, background:'#333', color:'#fff'});
                if(isUsingMock) renderLeaderboard(MOCK_DATA);
                else setTimeout(fetchLeaderboard, REFRESH_DELAY);
            });
        }
    });
  }

  function convertRegularToPoints(name){
    const reg = currentRegularTimes[name]||0;
    if(reg < 2){ Swal.fire({icon:'info', title:'æ™‚é–“ä¸è¶³', text:'ğŸ®ä¸€èˆ¬æ™‚é–“éœ€è‡³å°‘2åˆ†é˜', background:'#333', color:'#fff'}); return; }
    
    const maxPts = Math.floor(reg/2);

    Swal.fire({
        title: 'ğŸ® â” â­ è½‰æ›',
        text: `ç›®å‰ä¸€èˆ¬æ™‚é–“: ${reg} åˆ† (æœ€å¤šæ› ${maxPts} é»)`,
        input: 'number',
        inputValue: 1,
        inputAttributes: { min: 1, max: maxPts },
        showCancelButton: true,
        confirmButtonText: 'å…Œæ›',
        background: '#333', color: '#fff'
    }).then((result) => {
        if(result.isConfirmed){
            const want = parseInt(result.value);
            if(isNaN(want) || want <=0 || want > maxPts) {
                Swal.fire({icon:'error', title:'ç„¡æ•ˆæ•¸é‡', background:'#333', color:'#fff'}); return;
            }
            
            // æ…¶ç¥
            confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 } });
            
            startShimmer(name);
            const family=(name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
            const payload={
              Family:family, Name:name,
              PointsChange: want,
              SelectedMinutesChange:0,
              RegularMinutesChange: -(want*2),
              Reason:'ä¸€èˆ¬è½‰é»æ•¸'
            };
            submitToApi(payload, ()=>{
                stopShimmer(name);
                Swal.fire({icon:'success', title:`ç²å¾— ${want} é»!`, background:'#333', color:'#fff'});
                if(isUsingMock) renderLeaderboard(MOCK_DATA);
                else setTimeout(fetchLeaderboard, REFRESH_DELAY);
            });
        }
    });
  }

  function convertPointsToTime(name){
    const type = activeType[name]||'regular';
    const family=(name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
    
    // ç‚ºäº†æº–ç¢ºæ€§ï¼Œå¾è³‡æ–™æ‰¾é»æ•¸ï¼Œè€Œä¸æ˜¯DOM
    const entry = currentData.find(d=>d.Name===name) || MOCK_DATA.find(d=>d.Name===name);
    const hasPts = entry ? entry.TotalPoints : 0;
    
    if(hasPts <= 0){ Swal.fire({icon:'info', title:'é»æ•¸ä¸è¶³', background:'#333', color:'#fff'}); return; }

    const rate = (type==='selected') ? 3 : 2;
    const typeName = type==='selected'?'ğŸŒŸç²¾é¸':'ğŸ®ä¸€èˆ¬';

    Swal.fire({
        title: `â­ â” ${typeName} è½‰æ›`,
        html: `ç›®å‰é»æ•¸: ${hasPts}<br>åŒ¯ç‡: 1é» = ${rate}åˆ†`,
        input: 'number',
        inputValue: 1,
        inputAttributes: { min: 1, max: hasPts },
        showCancelButton: true,
        confirmButtonText: 'å…Œæ›',
        background: '#333', color: '#fff'
    }).then((result) => {
        if(result.isConfirmed){
            const want = parseInt(result.value);
            if(isNaN(want) || want <=0 || want > hasPts) return;

            startShimmer(name);
            const mins = want * rate;
            const payload={
              Family:family, Name:name,
              PointsChange: -want,
              SelectedMinutesChange: type==='selected'? mins:0,
              RegularMinutesChange:  type==='regular'? mins:0,
              Reason:`é»æ•¸è½‰${type==='selected'?'ç²¾é¸':'ä¸€èˆ¬'}`
            };
            submitToApi(payload, ()=>{
                stopShimmer(name);
                Swal.fire({icon:'success', title:`å¢åŠ  ${mins} åˆ†é˜!`, background:'#333', color:'#fff'});
                if(isUsingMock) renderLeaderboard(MOCK_DATA);
                else setTimeout(fetchLeaderboard, REFRESH_DELAY);
            });
        }
    });
  }
</script>

</body>
</html>
