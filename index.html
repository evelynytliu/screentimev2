<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <title>Points & Screen Time</title>
  <style>
    body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',sans-serif;background:#111;color:#eee;text-align:center;padding:20px}
    h1{margin:6px 0 14px}

    .child-card{background:#1c1c3c;padding:28px;margin:18px auto;border-radius:20px;box-shadow:0 4px 15px rgba(0,212,255,.4);max-width:440px;position:relative;overflow:hidden}
    .child-name{font-size:26px;font-weight:700;color:#00d4ff;margin-bottom:12px}
    .points-box{background:#222;padding:14px;border-radius:14px;font-size:34px;font-weight:800;color:#00d4ff;margin-bottom:8px;position:relative}
    .conversion-info{font-size:12px;color:#bbb;margin-top:4px}

    .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}

    /* é€šç”¨ï¼šç²¾é¸/ä¸€èˆ¬ */
    .chip-toggle{background:#222;border-radius:999px;padding:4px;display:inline-flex;gap:6px}
    .chip-toggle button{border:none;padding:8px 14px;border-radius:999px;background:#333;color:#bbb;cursor:pointer;font-weight:700;transition:.15s transform ease,.15s background ease}
    .chip-toggle button.active{background:#00d4ff;color:#111;transform:translateY(-1px)}

    /* æ–¹æ¡ˆåˆ‡æ›ï¼šä½¿ç”¨ç¨ç«‹ classï¼Œä¸¦å¼·åˆ¶è¦†è“‹èˆŠæ¨£å¼ */
    .plan-toggle{background:#222;border-radius:999px;padding:4px;display:inline-flex;gap:6px}
    .plan-toggle .btn-plan{
      border:none;padding:8px 14px;border-radius:999px;
      background:#333 !important;color:#bbb !important;cursor:pointer;font-weight:700;
      transition:.15s transform ease,.15s background ease
    }
    .plan-toggle .btn-plan.active{
      background:#00d4ff !important;color:#111 !important;transform:translateY(-1px)
    }

    .subtle{font-size:12px;color:#aaa}
    .progress-title{font-size:15px;color:#00d4ff;margin:8px 0 6px}
    .progress-dual{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:6px}
    .bar-wrap{background:#222;border:2px solid #00d4ff;border-radius:30px;overflow:hidden;height:42px;width:86%;margin:0 auto;position:relative}
    .fill{height:100%;width:0%;transition:width .5s ease;background:linear-gradient(90deg,#00d4ff,#005eff)}
    .bar-text{position:absolute;width:100%;text-align:center;top:0;line-height:42px;font-weight:700;color:#fff;font-size:18px}

    .control-row{display:grid;grid-template-columns:1fr;gap:8px;margin:10px 0}
    .control-row .left{display:flex;justify-content:center}
    .control-row .right{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
    .deduct-btn{padding:6px 0;font-size:16px;border-radius:10px;border:none;background:#333;color:#ccc;cursor:pointer}
    .deduct-btn:hover{background:#555}

    .convert-group{display:flex;justify-content:center;gap:10px;margin-top:6px}
    .btn{padding:8px 12px;font-size:16px;border:none;border-radius:8px;color:#eee;font-weight:700;cursor:pointer;background:#444}
    .btn:hover{background:#666}
    .btn.primary{background:#00d4ff;color:#111}

    #form-section{background:#2a2a5a;padding:20px;border-radius:20px;max-width:440px;margin:24px auto}
    input[type="number"],input[type="text"],button{padding:10px;margin:8px;font-size:16px;border-radius:8px;border:none;width:80%}
    #form-section button{background:#00d4ff;color:#111}

    #family-filter{display:flex;justify-content:center;gap:10px;margin-bottom:16px}
    #family-filter button{padding:10px 20px;font-size:16px;border-radius:8px;background:#333;color:#ccc;font-weight:700;border:none;cursor:pointer}
    #family-filter button.active-filter{background:#00d4ff;color:#111}
    #family-filter .small-button{padding:0;width:40px;height:40px;font-size:22px;display:flex;align-items:center;justify-content:center}

    .checkbox-group{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
    .checkbox-group input[type="checkbox"]{display:none}
    .checkbox-group label{display:inline-block;padding:12px 20px;background:#333;color:#ccc;border-radius:20px;font-size:18px;cursor:pointer;user-select:none;text-align:center}
    .checkbox-group input[type="checkbox"]:checked + label{background:#00d4ff;color:#111;font-weight:700}

    .loading-spinner{border:4px solid #333;border-top:4px solid #00d4ff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .shimmer-effect{position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,212,255,0) 0%,rgba(0,212,255,.2) 50%,rgba(0,212,255,0) 100%);background-size:200% 100%;animation:shimmer 4s infinite;pointer-events:none;z-index:10}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .note{font-size:13px;color:#bbb;margin-top:-2px}
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pill{display:inline-block;background:#222;border:1px dashed #444;padding:6px 10px;border-radius:999px;color:#bbb;font-size:12px}
    .preview{margin-top:6px;font-size:13px;color:#cfefff}
  </style>
</head>
<body>

<h1>â­ & ğŸ“º</h1>

<!-- å®¶åº­ç¯©é¸ -->
<div id="family-filter">
  <button type="button" onclick="setFamilyFilter('ev-family')">âš¡ é–ƒé›»æ£®æ—</button>
  <button type="button" onclick="setFamilyFilter('ap-family')">ğŸŠ æŸšæŸšä¾†é»å</button>
  <button type="button" onclick="clearFamilyFilter()" class="small-button">ğŸ”„</button>
</div>

<!-- å¡ç‰‡å€ -->
<div id="leaderboard">
  <div style="margin:20px">
    <div class="loading-spinner"></div>
    <div style="margin-top:10px;font-size:18px">è¼‰å…¥ä¸­...</div>
  </div>
</div>

<!-- å®¶é•·æ§åˆ¶ï¼ˆæ•´åˆæ–¹æ¡ˆåˆ‡æ›ï¼‰ -->
<div id="form-section">
  <h2>é€å‡ºæ–°ç´€éŒ„ ğŸ“</h2>
  <div id="name-list" class="checkbox-group"></div>

  <!-- æ–¹æ¡ˆåˆ‡æ›ï¼ˆç¨ç«‹ classï¼Œæœªé¸ç°ã€é¸å–è—ï¼‰ -->
  <div class="row" style="margin-top:4px;margin-bottom:0">
    <div class="plan-toggle" aria-label="é¸æ“‡åˆ†é…æ–¹æ¡ˆ">
      <button type="button" id="alloc-weekday" class="btn-plan" onclick="setAllocPlan('weekday')">å¹³æ—¥</button>
      <button type="button" id="alloc-holiday" class="btn-plan" onclick="setAllocPlan('holiday')">å‡æ—¥</button>
    </div>
  </div>
  <div id="alloc-preview" class="preview">â€”</div>

  <input type="number" id="pointsChange" placeholder="â­ é»æ•¸èª¿æ•´ï¼ˆ+/-ï¼‰">

  <div class="pair">
    <input type="number" id="selectedMinutesChange" placeholder="ğŸŒŸ ç²¾é¸æ™‚é–“ï¼ˆ+/- åˆ†ï¼‰">
    <input type="number" id="regularMinutesChange"  placeholder="ğŸ® ä¸€èˆ¬æ™‚é–“ï¼ˆ+/- åˆ†ï¼‰">
  </div>

  <input type="text" id="reason" placeholder="è®Šæ›´åŸå› ">
  <button type="button" onclick="submitData()">é€å‡º ğŸš€</button>

  <div class="note">è½‰æ›è¦å‰‡ï¼š<span class="pill">ğŸ® 2 åˆ† â†’ â­ 1 é»</span><span class="pill">â­ 1 é» â†’ ğŸ® 2 åˆ†</span><span class="pill">â­ 1 é» â†’ ğŸŒŸ 3 åˆ†</span>ï¼ˆğŸŒŸç²¾é¸ä¸å¯æ›å›â­ï¼‰</div>
</div>

<script>
  const REFRESH_DELAY = 1000;
  const API_URL = "https://script.google.com/macros/s/AKfycbzk2xXQLv3_e0oktEMZdQjXwkVG9JU6HTolS3dhRH09FPEiHn6dvyAUlUlQZpBAT0rG/exec";
  const PLAN_LIMITS = { weekday:{sel:20, reg:20}, holiday:{sel:30, reg:60} };

  let currentSelectedTimes = {};
  let currentRegularTimes  = {};
  let updatingChildren = {};
  let familyFilter = localStorage.getItem('familyFilter') || '';
  let allocPlan = localStorage.getItem('allocPlan') || 'weekday';
  let selMax = parseInt(localStorage.getItem('selMax')||'0',10);
  let regMax = parseInt(localStorage.getItem('regMax')||'0',10);
  if(!selMax || !regMax){
    selMax = PLAN_LIMITS[allocPlan].sel;
    regMax = PLAN_LIMITS[allocPlan].reg;
    localStorage.setItem('selMax', selMax);
    localStorage.setItem('regMax', regMax);
  }
  const activeType = {}; // { name: 'selected' | 'regular' }

  document.addEventListener('DOMContentLoaded', ()=>{
    fetchLeaderboard();
    syncAllocPlanButtons();
    updateAllocPreview();
  });

  /* å®¶åº­ç¯©é¸ */
  function setFamilyFilter(f){ familyFilter=f; localStorage.setItem('familyFilter',f); showLoading(); fetchLeaderboard(); updateFilterButtons(); }
  function clearFamilyFilter(){ familyFilter=''; localStorage.removeItem('familyFilter'); showLoading(); fetchLeaderboard(); updateFilterButtons();}
  function updateFilterButtons(){
    document.querySelectorAll('#family-filter button').forEach(b=>b.classList.remove('active-filter'));
    if(familyFilter){
      const btn = document.querySelector(`#family-filter button[onclick="setFamilyFilter('${familyFilter}')"]`);
      if(btn) btn.classList.add('active-filter');
    }
  }

  /* æ–¹æ¡ˆåˆ‡æ›ï¼šé å¡«ã€æ›´æ–°ä¸Šé™ã€å³æ™‚é‡ç®—é€²åº¦æ¢ */
  function setAllocPlan(plan){
    allocPlan = plan;
    localStorage.setItem('allocPlan', plan);
    syncAllocPlanButtons();

    const lim = PLAN_LIMITS[plan];
    document.getElementById('selectedMinutesChange').value = lim.sel;
    document.getElementById('regularMinutesChange').value  = lim.reg;
    document.getElementById('reason').value = buildTodayReason();

    selMax = lim.sel; regMax = lim.reg;
    localStorage.setItem('selMax', selMax);
    localStorage.setItem('regMax', regMax);
    updateAllocPreview(true);
    recalcAllProgressBars();
  }
  function syncAllocPlanButtons(){
    const w = document.getElementById('alloc-weekday');
    const h = document.getElementById('alloc-holiday');
    // ç¢ºä¿ä¸æœƒå…©é¡†åŒæ™‚è—
    w.classList.remove('active'); h.classList.remove('active');
    (allocPlan==='weekday' ? w : h).classList.add('active');
    w.setAttribute('aria-pressed', allocPlan==='weekday');
    h.setAttribute('aria-pressed', allocPlan==='holiday');
  }
  function buildTodayReason(){
    const d = new Date();
    const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} (${wd}) ç•¶æ—¥æ™‚é–“åˆ†é…`;
  }
  function updateAllocPreview(bump){
    const el = document.getElementById('alloc-preview');
    const lim = PLAN_LIMITS[allocPlan];
    el.textContent = `ç•¶å‰æ–¹æ¡ˆï¼š${allocPlan==='weekday'?'å¹³æ—¥':'å‡æ—¥'}ï¼ˆğŸŒŸ ${lim.sel} åˆ†ï½œğŸ® ${lim.reg} åˆ†ï¼‰ï¼›é€²åº¦æ¢ä¸Šé™ï¼šğŸŒŸ ${selMax}ï½œğŸ® ${regMax}`;
    if(bump){ el.style.transform='scale(1.04)'; setTimeout(()=>el.style.transform='none',150); }
  }

  function recalcAllProgressBars(){
    Object.keys(currentSelectedTimes).forEach(name=>{
      const sel = currentSelectedTimes[name]||0;
      const reg = currentRegularTimes[name]||0;
      const card = document.getElementById(`card-${name}`);
      if(!card) return;
      const titles = card.querySelectorAll('.progress-title');
      if(titles[0]) titles[0].textContent = `ğŸŒŸ ç²¾é¸æ™‚é–“ï¼ˆä¸Šé™ ${selMax} åˆ†ï¼‰`;
      if(titles[1]) titles[1].textContent = `ğŸ® ä¸€èˆ¬æ™‚é–“ï¼ˆä¸Šé™ ${regMax} åˆ†ï¼‰`;
      const fills = card.querySelectorAll('.fill');
      if(fills[0]) fills[0].style.width = `${Math.min(100, selMax? (sel/selMax)*100 : 0)}%`;
      if(fills[1]) fills[1].style.width = `${Math.min(100, regMax? (reg/regMax)*100 : 0)}%`;
    });
  }

  /* è¼‰å…¥æ’è¡Œæ¦œ */
  function showLoading(){
    document.getElementById('leaderboard').innerHTML = `
      <div style="margin:20px">
        <div class="loading-spinner"></div>
        <div style="margin-top:10px;font-size:18px">è¼‰å…¥ä¸­...</div>
      </div>`;
  }

  function fetchLeaderboard(){
    const callbackName = 'cb_' + Math.floor(Math.random()*1e6);
    window[callbackName] = function(data){
      renderLeaderboard(data);
      for(const name in updatingChildren){ stopShimmerEffect(name); }
      updatingChildren = {};
      delete window[callbackName];
    };
    const s=document.createElement('script');
    s.src = `${API_URL}?action=getLeaderboard&callback=${callbackName}`;
    s.onload = function(){ this.remove(); };
    document.body.appendChild(s);
    updateFilterButtons();
  }

  function renderLeaderboard(data){
    const leaderboard = document.getElementById('leaderboard');
    if(!Array.isArray(data)){ leaderboard.innerText='è¼‰å…¥å¤±æ•—'; return; }

    if(familyFilter){
      data = data.filter(e=>{
        if(familyFilter==='ev-family'){ return e.Name==='Miles'||e.Name==='Emmett';}
        if(familyFilter==='ap-family'){ return e.Name==='Tessa'||e.Name==='Archer';}
        return true;
      });
    }

    updateNameCheckboxes(data);

    let html = '';
    data.forEach(entry=>{
      const sel = entry.TotalSelectedMinutes || 0;
      const reg = entry.TotalRegularMinutes  || 0;
      const pts = entry.TotalPoints || 0;

      currentSelectedTimes[entry.Name] = sel;
      currentRegularTimes[entry.Name]  = reg;
      if(!activeType[entry.Name]) activeType[entry.Name]='regular';

      const selPct = Math.min(100, selMax ? (sel / selMax) * 100 : 0);
      const regPct = Math.min(100, regMax ? (reg / regMax) * 100 : 0);

      const cash = pts * 5;
      const canSel = pts * 3;
      const canReg = pts * 2;

      const opSelActive = activeType[entry.Name]==='selected';
      const opRegActive = activeType[entry.Name]==='regular';

      html += `
      <div class="child-card" id="card-${entry.Name}">
        <div class="child-name">ğŸ‘¦ ${entry.Name}</div>

        <div class="points-box">â­ ${pts} é»
          <div class="conversion-info">å¯æ›ï¼šğŸŒŸ ${canSel} åˆ†ï½œğŸ® ${canReg} åˆ†ï½œğŸ’° ${cash} å…ƒ</div>
        </div>

        <div class="progress-dual">
          <div>
            <div class="progress-title">ğŸŒŸ ç²¾é¸æ™‚é–“ï¼ˆä¸Šé™ ${selMax} åˆ†ï¼‰</div>
            <div class="bar-wrap">
              <div class="fill" style="width:${selPct}%"></div>
              <div class="bar-text">${sel} åˆ†é˜</div>
            </div>
          </div>
          <div>
            <div class="progress-title">ğŸ® ä¸€èˆ¬æ™‚é–“ï¼ˆä¸Šé™ ${regMax} åˆ†ï¼‰</div>
            <div class="bar-wrap">
              <div class="fill" style="width:${regPct}%"></div>
              <div class="bar-text">${reg} åˆ†é˜</div>
            </div>
          </div>
        </div>

        <div class="control-row">
          <div class="left">
            <div class="chip-toggle" aria-label="æ“ä½œç›®æ¨™">
              <button type="button" data-type="selected" class="${opSelActive?'active':''}" onclick="setOpType('${entry.Name}','selected')">ğŸŒŸ ç²¾é¸</button>
              <button type="button" data-type="regular"  class="${opRegActive?'active':''}" onclick="setOpType('${entry.Name}','regular')">ğŸ® ä¸€èˆ¬</button>
            </div>
          </div>
          <div class="right">
            ${[5,10,15,20,25,30].map(m=>`<button type="button" class="deduct-btn" onclick="deductScreenTime('${entry.Name}', ${m})">-${m}</button>`).join('')}
          </div>
        </div>

        <div class="convert-group">
          <button type="button" class="btn" onclick="convertRegularToPoints('${entry.Name}')">ğŸ® â” â­</button>
          <button type="button" class="btn convert-pts" onclick="convertPointsToTime('${entry.Name}')">â­ â” ${opSelActive?'ğŸŒŸ':'ğŸ®'}</button>
        </div>

        ${updatingChildren[entry.Name] ? '<div class="shimmer-effect"></div>' : ''}
      </div>
      `;
    });

    leaderboard.innerHTML = html;
  }

  function updateNameCheckboxes(data){
    const box = document.getElementById('name-list');
    box.innerHTML = '';
    data.forEach(e=>{
      const id = 'child-' + e.Name;
      const input = document.createElement('input');
      input.type='checkbox'; input.id=id; input.value=e.Name;
      const label = document.createElement('label');
      label.htmlFor=id; label.textContent=e.Name;
      box.appendChild(input); box.appendChild(label);
    });
  }

  /* ç²¾é¸/ä¸€èˆ¬åˆ‡æ›ï¼šç«‹å³æ›´æ–°å¡ç‰‡ï¼ˆä¸é‡æ–°æŠ“è³‡æ–™ï¼‰ */
  function setOpType(name, type){
    activeType[name]=type;
    const card = document.getElementById(`card-${name}`);
    if(!card) return;
    const btnSel = card.querySelector('.chip-toggle button[data-type="selected"]');
    const btnReg = card.querySelector('.chip-toggle button[data-type="regular"]');
    if(btnSel && btnReg){
      btnSel.classList.toggle('active', type==='selected');
      btnReg.classList.toggle('active', type==='regular');
    }
    const convertBtn = card.querySelector('.convert-group .convert-pts');
    if(convertBtn){
      convertBtn.textContent = `â­ â” ${type==='selected'?'ğŸŒŸ':'ğŸ®'}`;
    }
  }

  function startShimmerEffect(name){
    updatingChildren[name]=true;
    const card=document.getElementById(`card-${name}`);
    if(card && !card.querySelector('.shimmer-effect')){
      const d=document.createElement('div');
      d.className='shimmer-effect';
      card.appendChild(d);
    }
  }
  function stopShimmerEffect(name){
    delete updatingChildren[name];
    const card=document.getElementById(`card-${name}`);
    if(!card) return;
    const sh=card.querySelector('.shimmer-effect');
    if(sh) sh.remove();
  }

  function submitToApi(payload, callback){
    const iframe=document.createElement('iframe');
    iframe.style.display='none';
    iframe.onload=function(){ callback(); this.remove(); };
    iframe.src = `${API_URL}?action=submit&data=${encodeURIComponent(JSON.stringify(payload))}`;
    document.body.appendChild(iframe);
  }

  function submitData(){
    const checked=[...document.querySelectorAll('#name-list input[type="checkbox"]:checked')];
    const pointsChange = document.getElementById('pointsChange').value.trim();
    const selChange    = document.getElementById('selectedMinutesChange').value.trim();
    const regChange    = document.getElementById('regularMinutesChange').value.trim();
    const reason       = document.getElementById('reason').value.trim();

    if(checked.length===0){ alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹å°å­©'); return; }
    if(!pointsChange && !selChange && !regChange){ alert('è«‹è¼¸å…¥é»æ•¸æˆ–è¢å¹•æ™‚é–“èª¿æ•´'); return; }

    let done=0;
    checked.forEach(cb=>{
      const name=cb.value;
      const family = (name==='Miles'||name==='Emmett')?'ev-family':'ap-family';

      startShimmerEffect(name);
      const payload = {
        Family: family,
        Name: name,
        PointsChange: pointsChange ? parseInt(pointsChange,10):0,
        SelectedMinutesChange: selChange ? parseInt(selChange,10):0,
        RegularMinutesChange:  regChange ? parseInt(regChange,10):0,
        Reason: reason || 'å®¶é•·æ‰‹å‹•èª¿æ•´'
      };
      submitToApi(payload, ()=>{ if(++done===checked.length) setTimeout(fetchLeaderboard, REFRESH_DELAY); });
    });

    document.getElementById('pointsChange').value='';
    document.getElementById('selectedMinutesChange').value='';
    document.getElementById('regularMinutesChange').value='';
    document.getElementById('reason').value='';
    document.querySelectorAll('#name-list input[type="checkbox"]').forEach(cb=>cb.checked=false);
  }

  function deductScreenTime(name, minutes){
    const type = activeType[name] || 'regular';
    const current = (type==='selected') ? (currentSelectedTimes[name]||0) : (currentRegularTimes[name]||0);
    if(current < minutes){ alert(`è©²é¡åˆ¥æ™‚é–“ä¸è¶³ï¼Œç„¡æ³•æ‰£é™¤ ${minutes} åˆ†ï¼`); return; }
    const family=(name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
    if(!confirm(`ç¢ºå®šæ‰£é™¤ ${minutes} åˆ†ï¼ˆ${type==='selected'?'ğŸŒŸç²¾é¸':'ğŸ®ä¸€èˆ¬'}ï¼‰ï¼Ÿ`)) return;

    startShimmerEffect(name);
    const payload={
      Family:family, Name:name, PointsChange:0,
      SelectedMinutesChange: type==='selected' ? -minutes : 0,
      RegularMinutesChange:  type==='regular' ? -minutes : 0,
      Reason:`æ‰£é™¤${type==='selected'?'ç²¾é¸':'ä¸€èˆ¬'}æ™‚é–“ ${minutes} åˆ†`
    };
    submitToApi(payload, ()=> setTimeout(fetchLeaderboard, REFRESH_DELAY));
  }

  function convertRegularToPoints(name){
    const reg = currentRegularTimes[name]||0;
    if(reg<2){ alert('ğŸ® ä¸€èˆ¬æ™‚é–“ä¸è¶³ 2 åˆ†ï¼Œç„¡æ³•è½‰é»æ•¸'); return; }
    const maxPts = Math.floor(reg/2);
    const want = parseInt(prompt(`ç›®å‰ğŸ®ä¸€èˆ¬ ${reg} åˆ†ï¼Œå¯æ›æœ€é«˜ â­ ${maxPts} é»ã€‚\nè«‹è¼¸å…¥è¦æ›çš„é»æ•¸ï¼š`),10);
    if(isNaN(want)||want<=0||want>maxPts){ alert('è¼¸å…¥æ•¸é‡ç„¡æ•ˆ'); return; }

    const family=(name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
    const mins = want*2;

    if(!confirm(`ç¢ºèªè½‰æ›ï¼šğŸ® ${mins} åˆ† â†’ â­ ${want} é»`)) return;

    startShimmerEffect(name);
    const payload={
      Family:family, Name:name,
      PointsChange: want,
      SelectedMinutesChange:0,
      RegularMinutesChange: -mins,
      Reason:'ä¸€èˆ¬æ™‚é–“è½‰é»æ•¸ï¼ˆ2åˆ†â†’1é»ï¼‰'
    };
    submitToApi(payload, ()=>{ setTimeout(fetchLeaderboard, REFRESH_DELAY); alert(`å·²å°‡ ğŸ® ${mins} åˆ†æ›æˆ â­ ${want} é»`); });
  }

  function convertPointsToTime(name){
    const type = activeType[name]||'regular';
    const family=(name==='Miles'||name==='Emmett')?'ev-family':'ap-family';
    const ptsMatch = document.querySelector(`#card-${name} .points-box`)?.textContent.match(/(\d+)\s*é»/);
    const hasPts = ptsMatch ? parseInt(ptsMatch[1],10) : 0;
    if(hasPts<=0){ alert('æ²’æœ‰å¯è½‰æ›çš„é»æ•¸'); return; }

    const rate = (type==='selected') ? 3 : 2;
    const want = parseInt(prompt(`ç›®å‰ â­ ${hasPts} é»ã€‚\nè½‰ç‚º ${type==='selected'?'ğŸŒŸç²¾é¸':'ğŸ®ä¸€èˆ¬'}ï¼š1é»â†’${rate}åˆ†\nè«‹è¼¸å…¥è¦è½‰æ›çš„é»æ•¸ï¼š`),10);
    if(isNaN(want)||want<=0||want>hasPts){ alert('è¼¸å…¥æ•¸é‡ç„¡æ•ˆ'); return; }

    const mins = want*rate;
    if(!confirm(`ç¢ºèªè½‰æ›ï¼šâ­ ${want} é» â†’ ${type==='selected'?'ğŸŒŸ':''}${type==='regular'?'ğŸ®':''} ${mins} åˆ†`)) return;

    startShimmerEffect(name);
    const payload={
      Family:family, Name:name,
      PointsChange:-want,
      SelectedMinutesChange: type==='selected'? mins:0,
      RegularMinutesChange:  type==='regular'? mins:0,
      Reason:`é»æ•¸è½‰${type==='selected'?'ç²¾é¸':'ä¸€èˆ¬'}æ™‚é–“ï¼ˆ1é»â†’${rate}åˆ†ï¼‰`
    };
    submitToApi(payload, ()=>{ setTimeout(fetchLeaderboard, REFRESH_DELAY); alert(`å·²å°‡ â­ ${want} é»æ›æˆ ${type==='selected'?'ğŸŒŸç²¾é¸':'ğŸ®ä¸€èˆ¬'} ${mins} åˆ†`); });
  }
</script>

<div style="margin-top:60px;font-size:.9em;color:#aaa;text-align:center">
  Made by Evelyn YT ï½œ Â© 2025/8/31 17:55
</div>

</body>
</html>
